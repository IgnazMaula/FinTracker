@inject HttpClient Http
@inject IJSRuntime JS

<h4>Select a ticker:</h4>
<SymbolDropdownList />

@if (!string.IsNullOrWhiteSpace(SelectedCoinId))



{
    <div class="my-3">
        <gecko-coin-price-chart-widget @key="@($"{SelectedCoinId}-chart")"
                                       locale="en"
                                       outlined="true"
                                       coin-id="@SelectedCoinId"
                                       initial-currency="usd">
        </gecko-coin-price-chart-widget>
        <br />
        <gecko-coin-ticker-widget @key="@($"{SelectedCoinId}-ticker")"
                                  locale="en"
                                  outlined="true"
                                  coin-id="@SelectedCoinId"
                                  initial-currency="usd">
        </gecko-coin-ticker-widget>
    </div>
}

@* <SfChart Title="@SelectedCoinName">
    <ChartPrimaryXAxis Title="Date" ValueType="Syncfusion.Blazor.Charts.ValueType.Category" LabelRotation="45" />
    <ChartPrimaryYAxis Title="Price (USD)" ValueType="Syncfusion.Blazor.Charts.ValueType.Double" LabelFormat="${value}" />
    <ChartTooltipSettings Enable="true" />
    <ChartSeriesCollection>
        <ChartSeries DataSource="@stockPrices"
                     XName="Timestamp"
                     High="High"
                     Low="Low"
                     Open="Open"
                     Close="Close"
                     Name="@SelectedCoinName"
                     Type="ChartSeriesType.Candle">
        </ChartSeries>
    </ChartSeriesCollection>
</SfChart> *@

@code {
    private List<Coin> Coins = new();
    private List<StockPrice> stockPrices = new();
    private string SelectedCoinId = "bitcoin"; // default
    private string SelectedCoinName = "Bitcoin";

    protected override async Task OnInitializedAsync()
    {
        await LoadCoins();
        //await LoadChartData();
    }

    private async Task LoadCoins()
    {
        Coins = await Http.GetFromJsonAsync<List<Coin>>("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1");
    }

    private async Task LoadChartData()
    {
        var url = $"https://api.coingecko.com/api/v3/coins/{SelectedCoinId}/ohlc?vs_currency=usd&days=7";
        var response = await Http.GetFromJsonAsync<List<List<double>>>(url);

        if (response != null)
        {
            stockPrices = response.Take(30).Select(p => new StockPrice
            {
                Timestamp = DateTimeOffset.FromUnixTimeMilliseconds((long)p[0])
                            .ToLocalTime()
                            .ToString("MM-dd HH:mm"),
                Open = (decimal)p[1],
                High = (decimal)p[2],
                Low = (decimal)p[3],
                Close = (decimal)p[4]
            }).ToList();
        }

        SelectedCoinName = Coins.FirstOrDefault(c => c.Id == SelectedCoinId)?.Name ?? SelectedCoinId;
    }

    private async Task OnCoinChanged(ChangeEventArgs e)
    {
        SelectedCoinId = e.Value?.ToString() ?? "bitcoin";
        //await LoadChartData();

        // await Task.Delay(100);
        // await JS.InvokeVoidAsync("refreshGeckoWidgets");
    }

    public class Coin
    {
        public string Id { get; set; } = string.Empty;
        public string Symbol { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty; 
    }
    public class StockPrice
    {
        public string Timestamp { get; set; } = string.Empty;
        public decimal Open { get; set; }
        public decimal High { get; set; }
        public decimal Low { get; set; }
        public decimal Close { get; set; }
    }
}